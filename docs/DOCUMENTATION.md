# Documentation Technique - Printer Proofreading v3

## Table des mati??res

1. [Vue d'ensemble](#vue-densemble)
2. [Architecture](#architecture)
3. [Installation d??taill??e](#installation-d??taill??e)
4. [Guide d'utilisation](#guide-dutilisation)
5. [Algorithmes](#algorithmes)
6. [API et Fonctions](#api-et-fonctions)
7. [Personnalisation](#personnalisation)
8. [D??pannage avanc??](#d??pannage-avanc??)
9. [Roadmap](#roadmap)

---

## Vue d'ensemble

### Objectif

Printer Proofreading est un outil de contr??le qualit?? con??u pour comparer des fichiers PDF de designs originaux avec leurs ??preuves d'impression. L'application calcule un score de similarit?? structurelle (SSIM) pour identifier les diff??rences potentielles.

### Cas d'usage

- **Contr??le qualit?? packaging** : V??rifier que les fichiers envoy??s ?? l'imprimeur correspondent aux fichiers re??us
- **Validation pre-press** : S'assurer que les ??preuves sont conformes aux originaux
- **Archivage** : G??n??rer des rapports de validation pour tra??abilit??

### Versions disponibles

| Version | Interface | Description |
|---------|-----------|-------------|
| proofreading_v3.py | Tkinter Desktop | Version recommand??e avec d??tection de contenu |
| proofreading_v2.py | Tkinter Desktop | Version stable sans d??tection avanc??e |
| PROOFREADING_WEB | Flask Web | Interface web pour acc??s navigateur |
| STANDALONE_EXE | Tkinter Desktop | Version packag??e autonome |

---

## Architecture

### Diagramme de flux

```
?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
???                           STARTUP SCREEN                                  ???
???  ????????????????????????????????????????????????????????????????????????????????????    ????????????????????????????????????????????????????????????????????????????????????              ???
???  ??? DOSSIER DESIGN          ???    ??? DOSSIER IMPRIMEUR        ???              ???
???  ??? (drag & drop)           ???    ??? (drag & drop)            ???              ???
???  ????????????????????????????????????????????????????????????????????????????????????    ????????????????????????????????????????????????????????????????????????????????????              ???
???                           [COMMENCER L'ANALYSE]                           ???
?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
                                    ???
                                    ???
?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
???                           MAIN SCREEN                                     ???
???  ???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????     ???
???  ???                    SIMILARITY BAR                              ???     ???
???  ???  Code: XXXXXXXX  [========75%========|---] CONFORME   Seuil:85%???     ???
???  ???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????     ???
???                                                                           ???
???  ??????????????????????????????????????????????????????????????????????????????????????????????????????  ??????????????????????????????????????????????????????????????????????????????????????????????????????  ???
???  ???     ORIGINAL IMAGE            ???  ???     PRINTER IMAGE             ???  ???
???  ???                               ???  ???                               ???  ???
???  ???   ???????????????????????????????????????????????????????????????????????????????????????   ???   ???????????????????????????????????????????????????????????????????????????????????????   ???  ???
???  ???   ???                         ???   ???   ???                         ???   ???  ???
???  ???   ???    [Content Area]       ???   ???   ???    [Content Area]       ???   ???  ???
???  ???   ???                         ???   ???   ???                         ???   ???  ???
???  ???   ???????????????????????????????????????????????????????????????????????????????????????   ???   ???????????????????????????????????????????????????????????????????????????????????????   ???  ???
???  ???                               ???  ???                               ???  ???
???  ???   filename.pdf               ???  ???   filename.pdf               ???  ???
???  ???   Page 1/3                   ???  ???   Page 1/3                   ???  ???
???  ??????????????????????????????????????????????????????????????????????????????????????????????????????  ??????????????????????????????????????????????????????????????????????????????????????????????????????  ???
???                                                                           ???
???  [??? Page pr??c.]     Page 1/3    2/3 valid??es     [Page suiv. ???]          ???
???                                                                           ???
???  [<< PDF Pr??c??dent]  [Ajuster zone...]  [PDF Suivant >>]                 ???
???                                                                           ???
???  [??? Approuver]                              [??? Rejeter]                   ???
???                                                                           ???
???  ???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????     ???
???  ??? Code   ??? Filename     ??? Match  ??? Score ??? Status  ??? Comment ??? Date ???  ???
???  ???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????     ???
???  ??? XXXXXX ??? file1.pdf    ??? Both   ??? 95%   ??? Approved???         ??? ...  ???  ???
???  ??? YYYYYY ??? file2.pdf    ??? Both   ??? 72%   ??? Pending ???         ???      ???  ???
???  ???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????     ???
?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
```

### Structure des classes

```
ImageComparator (classe principale)
???
????????? Initialisation
???   ????????? __init__()
???   ????????? setup_startup_ui()
???   ????????? setup_main_ui()
???
????????? D??tection de contenu (V3)
???   ????????? detect_content_bounds()      # M??thode par seuil
???   ????????? detect_content_bounds_edge() # M??thode Canny
???   ????????? detect_content_region()      # M??thode hybride
???   ????????? draw_detection_overlay()     # Visualisation
???
????????? Comparaison
???   ????????? calculate_similarity()       # SSIM avec d??tection
???   ????????? _calculate_similarity_basic()# SSIM basique (fallback)
???   ????????? resize_preserve_aspect()     # Redimensionnement
???
????????? Gestion PDF
???   ????????? load_pdf_image()             # Chargement page
???   ????????? get_pdf_page_count()         # Compte pages
???   ????????? find_images()                # Scan dossier
???   ????????? extract_code()               # Code 8 caract??res
???
????????? Navigation
???   ????????? show_current_images()        # Affichage
???   ????????? show_previous() / show_next()# Nav PDF
???   ????????? show_previous_page() / show_next_page() # Nav pages
???
????????? Validation
???   ????????? validate_image()             # Approuver/Rejeter
???   ????????? count_validated_pages()      # Compteur
???   ????????? go_to_first_unvalidated_page()
???
????????? Export
???   ????????? export_to_csv()
???   ????????? copy_to_clipboard()
???
????????? Crop manuel
    ????????? CropDialog (classe)
    ????????? open_crop_dialog()
    ????????? show_crop_menu()
    ????????? reset_manual_crops()
```

### D??pendances

```
proofreading_v3.py
    ???
    ????????? tkinter (standard library)
    ???   ????????? filedialog, messagebox, ttk, simpledialog
    ???
    ????????? tkinterdnd2
    ???   ????????? DND_FILES, TkinterDnD
    ???
    ????????? PIL (Pillow)
    ???   ????????? Image, ImageTk, ImageDraw, ImageFont
    ???
    ????????? fitz (PyMuPDF)
    ???   ????????? Rendu PDF
    ???
    ????????? skimage (scikit-image)
    ???   ????????? ssim (structural_similarity)
    ???   ????????? canny (feature)
    ???
    ????????? scipy
    ???   ????????? ndimage (binary_dilation)
    ???
    ????????? numpy
        ????????? Manipulation tableaux
```

---

## Installation d??taill??e

### Pr??requis syst??me

| Composant | Minimum | Recommand?? |
|-----------|---------|------------|
| OS | Windows 10 | Windows 11 |
| Python | 3.8 | 3.10+ |
| RAM | 4 GB | 8 GB |
| Stockage | 500 MB | 1 GB |

### Installation pas ?? pas

#### 1. Cloner le repository

```bash
git clone https://github.com/yourusername/printer-proofreading.git
cd printer-proofreading
```

#### 2. Cr??er un environnement virtuel (recommand??)

```bash
python -m venv venv

# Windows
venv\Scripts\activate

# macOS/Linux
source venv/bin/activate
```

#### 3. Installer les d??pendances

```bash
pip install -r requirements.txt
```

#### 4. V??rifier l'installation

```bash
python -c "import fitz; import skimage; import tkinterdnd2; print('OK')"
```

### Probl??mes d'installation courants

#### tkinterdnd2 sur Windows

```bash
# Si erreur avec tkinterdnd2
pip uninstall tkinterdnd2
pip install tkinterdnd2-universal
```

#### PyMuPDF sur macOS

```bash
# Si erreur de compilation
brew install mupdf
pip install PyMuPDF --no-binary :all:
```

---

## Guide d'utilisation

### D??marrage rapide

1. **Lancer l'application**
   ```bash
   cd PROOFREADING
   python proofreading_v3.py
   ```

2. **S??lectionner les dossiers**
   - Glisser-d??poser le dossier DESIGN sur la zone gauche
   - Glisser-d??poser le dossier IMPRIMEUR sur la zone droite
   - Cliquer "COMMENCER L'ANALYSE"

3. **Valider les fichiers**
   - Examiner chaque paire c??te ?? c??te
   - Cliquer "Approuver" ou "Rejeter"
   - Les PDFs multi-pages n??cessitent la validation de chaque page

4. **Exporter les r??sultats**
   - Menu Fichier > Exporter en CSV
   - Ou cliquer "Copier dans le presse-papiers"

### Syst??me de correspondance des fichiers

Les fichiers sont appair??s par leurs **8 premiers caract??res** :

```
DOSSIER DESIGN/                    DOSSIER IMPRIMEUR/
???                                  ???
????????? 12345678_design_v2.pdf   <-->  ????????? 12345678_print_v1.pdf
????????? ABCD1234_product.pdf     <-->  ????????? ABCD1234_proof.pdf
????????? XYZ98765_label.pdf       <-->  ????????? XYZ98765.pdf
```

### Navigation multi-pages

Pour les PDFs avec plusieurs pages :

| ??l??ment | Description |
|---------|-------------|
| "Page 1/3" | Indicateur de page actuelle |
| "??? Page pr??c." | Aller ?? la page pr??c??dente |
| "Page suiv. ???" | Aller ?? la page suivante |
| "2/3 pages valid??es" | Statut de validation |

**R??gles de validation** :
- Chaque page doit ??tre valid??e individuellement
- Le PDF est "Approved" si TOUTES les pages sont approuv??es
- Le PDF est "Rejected" si AU MOINS UNE page est rejet??e

### Ajustement manuel de la zone

Quand la d??tection automatique ??choue :

1. Cliquer "Ajuster zone..."
2. Choisir "Ajuster Original" ou "Ajuster Imprimeur"
3. Dessiner un rectangle autour du contenu
4. Cliquer "Valider"

La zone ajust??e persiste jusqu'au changement de PDF.

### Interpr??tation des scores

| Score | Signification | Action |
|-------|---------------|--------|
| 95-100% | Quasi identique | Approuver |
| 85-94% | Tr??s similaire, petites diff??rences | V??rifier |
| 70-84% | Diff??rences notables | Examiner attentivement |
| <70% | Diff??rences significatives | Rejeter ou v??rifier |

---

## Algorithmes

### D??tection de contenu par seuil

```python
def detect_content_bounds(img, margin_threshold=250, min_content_ratio=0.05):
    """
    D??tecte la zone de contenu en identifiant les pixels non-blancs.

    Param??tres:
    - margin_threshold: Valeur de gris max pour consid??rer un pixel comme "blanc" (0-255)
    - min_content_ratio: Ratio minimum de pixels "contenu" par ligne/colonne

    Algorithme:
    1. Convertir en niveaux de gris
    2. Cr??er un masque: pixel < threshold = contenu
    3. Calculer le ratio de contenu par ligne et colonne
    4. Trouver les limites o?? ratio > min_content_ratio
    5. Ajouter un padding de 2%
    """
```

### D??tection de contenu par contours (Canny)

```python
def detect_content_bounds_edge(img, sigma=2.0):
    """
    Utilise la d??tection de contours Canny pour les designs blancs sur blanc.

    Param??tres:
    - sigma: ??cart-type du filtre gaussien (flou pr??-Canny)

    Algorithme:
    1. Convertir en niveaux de gris normalis??s [0, 1]
    2. Appliquer Canny (low=0.1, high=0.3)
    3. Dilater les contours (3 it??rations)
    4. Trouver les coordonn??es min/max des contours
    5. Ajouter un padding de 5%
    """
```

### M??thode hybride

```python
def detect_content_region(img):
    """
    Combine les deux m??thodes pour une d??tection robuste.

    Logique:
    1. Essayer la m??thode par seuil
    2. Si ratio contenu entre 15% et 95% et zone > 100px ?? OK (confiance 90%)
    3. Sinon, essayer la m??thode par contours
    4. Si ratio entre 15% et 95% ?? OK (confiance 70%)
    5. Sinon, retourner l'image enti??re (confiance 50%)

    Retourne: (bounds, confidence, method)
    - bounds: (left, top, right, bottom)
    - confidence: 0.0 ?? 1.0
    - method: 'threshold', 'edge', 'full', 'manual', 'disabled'
    """
```

### Calcul SSIM

```python
def calculate_similarity(img1, img2):
    """
    Calcule la similarit?? structurelle avec d??tection de contenu.

    Pipeline:
    1. D??tecter les r??gions de contenu (ou utiliser les bounds manuels)
    2. Recadrer les images sur ces r??gions
    3. Redimensionner ?? 800x800 (aspect ratio pr??serv??, padding blanc)
    4. Convertir en niveaux de gris
    5. Calculer SSIM via scikit-image
    6. Retourner score [0.0, 1.0]
    """
```

---

## API et Fonctions

### Fonctions principales

#### `load_pdf_image(pdf_path, page_number=0)`

```python
def load_pdf_image(self, pdf_path, page_number=0):
    """
    Charge une page sp??cifique d'un PDF.

    Args:
        pdf_path (str): Chemin absolu vers le fichier PDF
        page_number (int): Num??ro de la page (0-indexed)

    Returns:
        tuple: (Image PIL, int nombre total de pages)
               (None, 0) en cas d'erreur

    Exemple:
        img, total = self.load_pdf_image("document.pdf", page_number=2)
        if img:
            print(f"Page 3/{total} charg??e")
    """
```

#### `calculate_similarity(img1, img2)`

```python
def calculate_similarity(self, img1, img2):
    """
    Calcule le score de similarit?? entre deux images.

    Args:
        img1 (PIL.Image): Image originale
        img2 (PIL.Image): Image imprimeur

    Returns:
        float: Score entre 0.0 et 1.0

    Effets de bord:
        - Met ?? jour self.last_detection avec les bounds et confiance
        - Met ?? jour self.needs_warning si confiance < 50%
    """
```

#### `validate_image(approved)`

```python
def validate_image(self, approved):
    """
    Valide la page actuelle.

    Args:
        approved (bool): True pour approuver, False pour rejeter

    Comportement:
        - Si reject??, demande un commentaire
        - Enregistre la validation dans self.page_validations
        - Met ?? jour le statut global du PDF
        - Navigue vers la page/PDF suivant automatiquement
    """
```

### Variables d'??tat importantes

```python
# Navigation
self.current_index        # Index du PDF actuel dans la liste filtr??e
self.current_page         # Num??ro de page actuel (0-indexed)
self.total_pages_original # Nombre de pages du PDF original
self.total_pages_printer  # Nombre de pages du PDF imprimeur

# D??tection
self.auto_crop_enabled    # D??tection automatique activ??e
self.show_crop_overlay    # Afficher le rectangle de d??tection
self.manual_bounds_original  # Bounds manuels pour l'original
self.manual_bounds_printer   # Bounds manuels pour l'imprimeur
self.last_detection       # Derni??res infos de d??tection

# Validation
self.page_validations     # {(index, page): 'Approved'/'Rejected'}
self.similarity_threshold # Seuil de similarit?? (0.0-1.0)
self.similarity_enabled   # Score de similarit?? activ??
```

---

## Personnalisation

### Modifier les param??tres de d??tection

Dans `detect_content_bounds()` :

```python
# Ajuster la sensibilit?? au blanc
margin_threshold=250  # Augmenter pour plus de tol??rance (200-255)

# Ajuster le ratio minimum de contenu
min_content_ratio=0.05  # Diminuer pour d??tecter moins de contenu (0.01-0.10)
```

Dans `detect_content_bounds_edge()` :

```python
# Ajuster le flou pr??-Canny
sigma=2.0  # Augmenter pour moins de bruit (1.0-5.0)

# Ajuster les seuils Canny
low_threshold=0.1   # (0.05-0.2)
high_threshold=0.3  # (0.2-0.5)
```

### Modifier la r??solution de rendu

Dans `load_pdf_image()` :

```python
# R??solution actuelle: 2x
pix = page.get_pixmap(matrix=fitz.Matrix(2, 2))

# Pour une meilleure qualit?? (plus lent, plus de m??moire)
pix = page.get_pixmap(matrix=fitz.Matrix(3, 3))

# Pour plus de rapidit?? (moins de d??tail)
pix = page.get_pixmap(matrix=fitz.Matrix(1.5, 1.5))
```

### Modifier la taille de comparaison

Dans `calculate_similarity()` :

```python
# Taille actuelle: 800x800
target_size = (800, 800)

# Pour plus de pr??cision (plus lent)
target_size = (1200, 1200)

# Pour plus de rapidit??
target_size = (400, 400)
```

### Ajouter des raccourcis clavier

Dans `setup_main_ui()`, apr??s la cr??ation de la fen??tre :

```python
# Exemple: raccourcis fl??ches
self.master.bind('<Left>', lambda e: self.show_previous())
self.master.bind('<Right>', lambda e: self.show_next())
self.master.bind('<Up>', lambda e: self.show_previous_page())
self.master.bind('<Down>', lambda e: self.show_next_page())
self.master.bind('<Return>', lambda e: self.validate_image(True))
self.master.bind('<BackSpace>', lambda e: self.validate_image(False))
```

---

## D??pannage avanc??

### Probl??mes de m??moire

**Sympt??me** : L'application ralentit ou plante avec de nombreux fichiers

**Solutions** :
1. R??duire la r??solution de rendu PDF (voir Personnalisation)
2. Traiter les fichiers par lots plus petits
3. Fermer et relancer l'application entre les lots

### Scores incoh??rents

**Sympt??me** : Scores bas pour des fichiers identiques

**V??rifications** :
1. V??rifier que la d??tection de contenu fonctionne (rectangle vert visible)
2. Utiliser le crop manuel si n??cessaire
3. V??rifier que les deux PDFs ont le m??me nombre de pages
4. Comparer les m??mes num??ros de page

### Fichiers non appair??s

**Sympt??me** : "Original only" ou "Printer only" alors que les fichiers existent

**V??rifications** :
1. V??rifier les 8 premiers caract??res des noms de fichiers
2. V??rifier l'encodage des caract??res (??viter accents/sp??ciaux)
3. V??rifier les extensions (.pdf en minuscules)

### Erreur de chargement PDF

**Sympt??me** : "Could not load PDF"

**V??rifications** :
1. Ouvrir le fichier dans un lecteur PDF standard
2. V??rifier que le fichier n'est pas corrompu
3. V??rifier les permissions de lecture
4. Essayer de r??-exporter le PDF depuis l'application source

### Logs de d??bogage

Ajouter des logs pour le diagnostic :

```python
import logging
logging.basicConfig(level=logging.DEBUG)

# Dans les fonctions critiques
logging.debug(f"Loading PDF: {pdf_path}, page: {page_number}")
logging.debug(f"Detection bounds: {bounds}, confidence: {conf}")
logging.debug(f"SSIM score: {score}")
```

---

## Roadmap

### V3.1 (Planifi??)

- [ ] Raccourcis clavier configurables
- [ ] Zoom sur les images
- [ ] Historique des crops manuels par fichier
- [ ] Am??lioration de la d??tection pour les gradients

### V4.0 (Futur)

- [ ] Int??gration IA pour cas ambigus (Claude Vision / GPT-4V)
- [ ] D??tection automatique des diff??rences visuelles
- [ ] Mode batch sans interface graphique (CLI)
- [ ] Support des formats additionnels (AI, EPS, TIFF)

### V5.0 (Vision)

- [ ] Application web compl??te avec base de donn??es
- [ ] Multi-utilisateurs avec gestion des droits
- [ ] API REST pour int??gration dans workflows existants
- [ ] Rapports PDF automatiques

---

## Support

### Signaler un bug

1. V??rifier que le bug n'est pas d??j?? signal??
2. Cr??er une issue sur GitHub avec :
   - Version de l'application
   - Syst??me d'exploitation
   - ??tapes pour reproduire
   - Message d'erreur complet
   - Fichiers de test (si possible)

### Contribuer

Voir [CONTRIBUTING.md](CONTRIBUTING.md) pour les guidelines de contribution.

---

*Documentation g??n??r??e pour Printer Proofreading v3.0.0*
